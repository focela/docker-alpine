#!/command/with-contenv bash
#-----------------------------------------------------------------------------
# Logging Configuration Variables
#
# Purpose: Defines default environment variables for logging and log shipping
# Context: Loaded during container initialization to configure logging systems
# Note: Fluent Bit and logrotate settings with OS-specific fallback defaults
#-----------------------------------------------------------------------------



#-----------------------------------------------------------------------------
# FLUENT BIT BASIC CONFIGURATION
#-----------------------------------------------------------------------------
# Core Fluent Bit settings and mode configuration
FLUENTBIT_MODE=${FLUENTBIT_MODE:-"NORMAL"}
FLUENTBIT_SETUP_TYPE=${FLUENTBIT_SETUP_TYPE:-"AUTO"}
FLUENTBIT_OUTPUT=${FLUENTBIT_OUTPUT:-"FORWARD"}

# Configuration files
FLUENTBIT_CONFIG_PARSERS=${FLUENTBIT_CONFIG_PARSERS:-"parsers.conf"}
FLUENTBIT_CONFIG_PLUGINS=${FLUENTBIT_CONFIG_PLUGINS:-"plugins.conf"}

#-----------------------------------------------------------------------------
# FLUENT BIT LOGGING SETTINGS
#-----------------------------------------------------------------------------
# Log file and level configuration
FLUENTBIT_LOG_FILE=${FLUENTBIT_LOG_FILE:-"fluentbit.log"}
FLUENTBIT_LOG_LEVEL=${FLUENTBIT_LOG_LEVEL:-"info"}
FLUENTBIT_LOG_PATH=${FLUENTBIT_LOG_PATH:-"/var/log/fluentbit/"}

#-----------------------------------------------------------------------------
# FLUENT BIT HTTP SERVER
#-----------------------------------------------------------------------------
# HTTP server configuration for monitoring and metrics
FLUENTBIT_ENABLE_HTTP_SERVER=${FLUENTBIT_ENABLE_HTTP_SERVER:-"TRUE"}
FLUENTBIT_HTTP_LISTEN_IP=${FLUENTBIT_HTTP_LISTEN_IP:-"0.0.0.0"}
FLUENTBIT_HTTP_LISTEN_PORT=${FLUENTBIT_HTTP_LISTEN_PORT:-"2020"}

# Storage metrics configuration
FLUENTBIT_ENABLE_STORAGE_METRICS=${FLUENTBIT_ENABLE_STORAGE_METRICS:-"TRUE"}

#-----------------------------------------------------------------------------
# FLUENT BIT PERFORMANCE SETTINGS
#-----------------------------------------------------------------------------
# Buffer and flush configuration
FLUENTBIT_FLUSH_SECONDS=${FLUENTBIT_FLUSH_SECONDS:-"1"}
FLUENTBIT_GRACE_SECONDS=${FLUENTBIT_GRACE_SECONDS:-"1"}

# Forward buffer settings
FLUENTBIT_FORWARD_BUFFER_CHUNK_SIZE=${FLUENTBIT_FORWARD_BUFFER_CHUNK_SIZE:-"1M"}
FLUENTBIT_FORWARD_BUFFER_MAX_SIZE=${FLUENTBIT_FORWARD_BUFFER_MAX_SIZE:-"6M"}
FLUENTBIT_FORWARD_PORT=${FLUENTBIT_FORWARD_PORT:-"24224"}

# Tail buffer settings
FLUENTBIT_TAIL_BUFFER_CHUNK_SIZE=${FLUENTBIT_TAIL_BUFFER_CHUNK_SIZE:-"32k"}
FLUENTBIT_TAIL_BUFFER_MAX_SIZE=${FLUENTBIT_TAIL_BUFFER_MAX_SIZE:-"32k"}

#-----------------------------------------------------------------------------
# FLUENT BIT STORAGE CONFIGURATION
#-----------------------------------------------------------------------------
# Storage settings for data persistence
FLUENTBIT_STORAGE_PATH=${FLUENTBIT_STORAGE_PATH:-"/tmp/fluentbit/storage"}
FLUENTBIT_STORAGE_BACKLOG_LIMIT=${FLUENTBIT_STORAGE_BACKLOG_LIMIT:-"5M"}
FLUENTBIT_STORAGE_CHECKSUM=${FLUENTBIT_STORAGE_CHECKSUM:-"FALSE"}
FLUENTBIT_STORAGE_SYNC=${FLUENTBIT_STORAGE_SYNC:-"normal"}

#-----------------------------------------------------------------------------
# FLUENT BIT TAIL INPUT SETTINGS
#-----------------------------------------------------------------------------
# File tailing configuration
FLUENTBIT_TAIL_READ_FROM_HEAD=${FLUENTBIT_TAIL_READ_FROM_HEAD:-"FALSE"}
FLUENTBIT_TAIL_SKIP_EMPTY_LINES=${FLUENTBIT_TAIL_SKIP_EMPTY_LINES:-"TRUE"}
FLUENTBIT_TAIL_SKIP_LONG_LINES=${FLUENTBIT_TAIL_SKIP_LONG_LINES:-"TRUE"}

# Tail database settings
FLUENTBIT_TAIL_DB_ENABLE=${FLUENTBIT_TAIL_DB_ENABLE:-"TRUE"}
FLUENTBIT_TAIL_DB_SYNC=${FLUENTBIT_TAIL_DB_SYNC:-"normal"}
FLUENTBIT_TAIL_DB_LOCK=${FLUENTBIT_TAIL_DB_LOCK:-"TRUE"}
FLUENTBIT_TAIL_DB_JOURNAL_MODE=${FLUENTBIT_TAIL_DB_JOURNAL_MODE:-"WAL"}

# Tail key configuration
FLUENTBIT_TAIL_KEY_PATH_ENABLE=${FLUENTBIT_TAIL_KEY_PATH_ENABLE:-"TRUE"}
FLUENTBIT_TAIL_KEY_PATH=${FLUENTBIT_TAIL_KEY_PATH:-"filename"}
FLUENTBIT_TAIL_KEY_OFFSET_ENABLE=${FLUENTBIT_TAIL_KEY_OFFSET_ENABLE:-"FALSE"}
FLUENTBIT_TAIL_KEY_OFFSET=${FLUENTBIT_TAIL_KEY_OFFSET:-"offset"}

#-----------------------------------------------------------------------------
# FLUENT BIT OUTPUT CONFIGURATION
#-----------------------------------------------------------------------------
# Forward output settings
FLUENTBIT_OUTPUT_FORWARD_HOST=${FLUENTBIT_OUTPUT_FORWARD_HOST:-"fluent-proxy"}
FLUENTBIT_OUTPUT_FORWARD_TLS=${FLUENTBIT_OUTPUT_FORWARD_TLS:-"FALSE"}
FLUENTBIT_OUTPUT_FORWARD_TLS_VERIFY=${FLUENTBIT_OUTPUT_FORWARD_TLS_VERIFY:-"FALSE"}

# Loki output settings
FLUENTBIT_OUTPUT_LOKI_HOST=${FLUENTBIT_OUTPUT_LOKI_HOST:-"loki"}
FLUENTBIT_OUTPUT_LOKI_PORT=${FLUENTBIT_OUTPUT_LOKI_PORT:-"3100"}
FLUENTBIT_OUTPUT_LOKI_TLS=${FLUENTBIT_OUTPUT_LOKI_TLS:-"FALSE"}
FLUENTBIT_OUTPUT_LOKI_TLS_VERIFY=${FLUENTBIT_OUTPUT_LOKI_TLS_VERIFY:-"FALSE"}
FLUENTBIT_OUTPUT_LOKI_COMPRESS_GZIP=${FLUENTBIT_OUTPUT_LOKI_COMPRESS_GZIP:-"gzip"}

#-----------------------------------------------------------------------------
# LOGROTATE CONFIGURATION
#-----------------------------------------------------------------------------
# Log rotation settings and compression configuration
LOGROTATE_COMPRESSION_VALUE=${LOGROTATE_COMPRESSION_VALUE:-"8"}
LOGROTATE_RETAIN_DAYS=${LOGROTATE_RETAIN_DAYS:-"7"}
LOGSHIPPING_AUTO_CONFIG_LOGROTATE=${LOGSHIPPING_AUTO_CONFIG_LOGROTATE:-"TRUE"}

#-----------------------------------------------------------------------------
# OS-SPECIFIC COMPRESSION TYPE DETECTION
#-----------------------------------------------------------------------------
# Automatically select compression type based on OS
if [ -z "${LOGROTATE_COMPRESSION_TYPE}" ]; then
  if [ -f /etc/os-release ]; then
    # Extract OS identifier and version from /etc/os-release file
    detected_os_id=$(grep "^ID=" /etc/os-release | cut -d = -f2 | tr -d '"')
    detected_os_version=$(grep "^VERSION_ID=" /etc/os-release | cut -d = -f 2 | tr -d '"')
    
    case ${detected_os_id} in
      "alpine" )
        # Alpine version detection for compression choice
        if [ "$detected_os_version" = "edge" ]; then
          # Edge releases check zstd with gzip fallback
          if command -v zstd >/dev/null 2>&1; then
            LOGROTATE_COMPRESSION_TYPE="zstd"
          else
            # Fallback to gzip if zstd unavailable
            LOGROTATE_COMPRESSION_TYPE="gzip"
          fi
        else
          # Parse version for comparison
          alpine_version_major_minor=$(echo "$detected_os_version" | cut -d . -f 1,2)
          
          case ${alpine_version_major_minor} in
            "3.5" | "3.6" | "3.7" | "3.8" | "3.9" )
              # Alpine 3.5-3.9 use gzip for compatibility
              LOGROTATE_COMPRESSION_TYPE="gzip"
            ;;
            "3.10" | "3.11" | "3.12" | "3.13" | "3.14" | "3.15" | "3.16" | "3.17" | "3.18" | "3.19" | "3.20" | "3.21" | "3.22" | "3.23" | "3.24" | "3.25" | "3.26" | "3.27" | "3.28" | "3.29" )
              # Alpine 3.10+ check zstd availability
              if command -v zstd >/dev/null 2>&1; then
                LOGROTATE_COMPRESSION_TYPE="zstd"
              else
                # Fallback to gzip if zstd unavailable
                LOGROTATE_COMPRESSION_TYPE="gzip"
              fi
            ;;
            * )
              # Unknown version defaults to gzip as safe choice
              LOGROTATE_COMPRESSION_TYPE="gzip"
            ;;
          esac
        fi
      ;;
      "debian" | "ubuntu" )
        # Debian/Ubuntu check for zstd availability
        if command -v zstd >/dev/null 2>&1; then
          LOGROTATE_COMPRESSION_TYPE="zstd"
        else
          # Fallback to gzip if zstd unavailable
          LOGROTATE_COMPRESSION_TYPE="gzip"
        fi
      ;;
      * )
        # Other OS use gzip as safe default
        LOGROTATE_COMPRESSION_TYPE="gzip"
      ;;
    esac
  else
    # Fallback to gzip if OS info unavailable
    LOGROTATE_COMPRESSION_TYPE="gzip"
  fi
fi
