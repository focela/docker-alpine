#!/command/with-contenv bash
#-----------------------------------------------------------------------------
# Container Messaging Configuration Script
#
# Purpose: Configures SMTP messaging backend (msmtp) for container email delivery
#          with support for TLS, authentication, and Gmail integration
# Context: Runs during container initialization phase via s6-overlay cont-init.d
# Note: Only configures messaging if ENABLE_SMTP is set to TRUE
#-----------------------------------------------------------------------------



#-----------------------------------------------------------------------------
# INITIAL SETUP
#-----------------------------------------------------------------------------
# Source container core functions and prepare messaging service
source /assets/functions/00-container
output_off
prepare_service single
# shellcheck disable=SC2034
PROCESS_NAME="messaging"

#-----------------------------------------------------------------------------
# MESSAGING FEATURE ENABLEMENT
#-----------------------------------------------------------------------------
# Enable or disable messaging based on SMTP configuration
if var_false "${ENABLE_SMTP}"; then 
  CONTAINER_ENABLE_MESSAGING=FALSE 
fi

if var_true "${ENABLE_SMTP}"; then
  CONTAINER_ENABLE_MESSAGING=TRUE
  CONTAINER_MESSAGING_BACKEND=msmtp
fi

#-----------------------------------------------------------------------------
# MESSAGING BACKEND CONFIGURATION
#-----------------------------------------------------------------------------
# Configure messaging backend if enabled
if var_true "${CONTAINER_ENABLE_MESSAGING}" ; then
  case "${CONTAINER_MESSAGING_BACKEND,,}" in
    "msmtp" )
      #-----------------------------------------------------------------------------
      # MSMTP INFRASTRUCTURE SETUP
      #-----------------------------------------------------------------------------
      # Replace system sendmail with msmtp for container email routing
      rm -f /usr/sbin/sendmail
      ln -s /usr/bin/msmtp /usr/sbin/sendmail
      
      # Convert boolean values to on/off format for msmtp configuration
      truefalse_onoff SMTP_TLS lower
      truefalse_onoff SMTP_STARTTLS lower
      truefalse_onoff SMTP_TLSCERTCHECK lower
      
      # Transform SMTP configuration variables from file sources
      transform_file_var \
        SMTP_HOST \
        SMTP_PORT \
        SMTP_USER \
        SMTP_PASS

      #-----------------------------------------------------------------------------
      # MSMTP CONFIGURATION FILE GENERATION
      #-----------------------------------------------------------------------------
      # Generate msmtp configuration file with all SMTP settings
      echo "### Automatically generated on container start. See documentation on how to set!" > /etc/msmtprc
      {
        echo "account default "
        echo "host ${SMTP_HOST}"
        echo "port ${SMTP_PORT}"
        echo "domain ${SMTP_DOMAIN}"
        if [ -n "$SMTP_FROM" ]; then 
          echo "from ${SMTP_FROM}"
        fi
        echo "maildomain ${SMTP_MAILDOMAIN}"
        if [ -n "$SMTP_AUTHENTICATION" ]; then 
          echo "auth ${SMTP_AUTHENTICATION}"
        fi
        if [ -n "$SMTP_USER" ]; then 
          echo "user ${SMTP_USER}"
        fi
        if [ -n "$SMTP_PASS" ]; then 
          echo "password ${SMTP_PASS}"
        fi
        echo "tls ${SMTP_TLS}"
        echo "tls_starttls ${SMTP_STARTTLS}"
        echo "tls_certcheck ${SMTP_TLSCERTCHECK}"
        if [ -n "$SMTP_ALLOW_FROM_OVERRIDE" ]; then 
          echo "allow_from_override ${SMTP_ALLOW_FROM_OVERRIDE}"
        fi             
        if var_true "${ENABLE_SMTP_GMAIL}" || var_true "${SMTP_AUTO_FROM}"; then 
          echo "auto_from on"
        fi
      } >> /etc/msmtprc

      print_notice "Container configured to route mail via SMTP to '${SMTP_HOST}'"
    ;;
    
    * )
      print_error "Unknown messaging backend"
      exit 1
    ;;
  esac
else
  # Messaging is disabled, no configuration needed
  :
fi

#-----------------------------------------------------------------------------
# FINAL INITIALIZATION
#-----------------------------------------------------------------------------
# Complete messaging configuration sequence
liftoff
output_on
